#!/usr/bin/env python3
"""
``doks``

"""
from . import shields
from . import variables
import datetime
import impall
import inspect
import os
import safer
import sys

__all__ = ('doks',)


def _doks(path):
    """Print documentation for a file or module

    ARGUMENTS
      path: path to the Python file or module.
    """
    module = impall.import_file(path)
    module_doc = _get_doc(module)

    def_vars = variables.default_variables(path)
    yield from shields.add_shields(module_doc, def_vars)
    yield ''
    yield from _header('API', '*')
    yield from _print_children(module, module.__all__, module.__name__)

    timestamp = datetime.datetime.now().isoformat()
    yield '(automatically generated by doks on %s)' % timestamp


def _get_doc(s):
    lines = (s.__doc__ or '').splitlines()
    while lines and not lines[-1].strip():
        lines.pop()

    while lines and not lines[0].strip():
        lines.pop(0)

    prefix = os.path.commonprefix([i for i in lines if i.strip()])
    blanks = len(prefix) - len(prefix.lstrip())
    return [i[blanks:] for i in lines]


def _indent(lines):
    for line in lines:
        if line.strip():
            line = '    ' + line
        yield line


def _header(line, char='-'):
    header = char * len(line)
    if char in '*#':
        yield header
    yield from (line, header, '')


def _print_children(parent, names, module_path):
    for path, value in _children(parent, names, module_path):
        if isinstance(value, type):
            header = 'Class ``%s``' % path
            char = '='
        else:
            sig = str(inspect.signature(value))
            header = '``%s%s``' % (path, sig)
            char = '-'
        yield from _header(header, char)
        yield from _indent(_get_doc(value))
        yield ''


def _children(parent, names, module_path):
    for name in names:
        if name.startswith('_') and not name.startswith('__'):
            continue
        value = getattr(parent, name)
        is_type = isinstance(value, type)
        if not (is_type or callable(value)):
            path = '%s.%s' % (module_path, name)
            yield path, value
            if is_type:
                yield from _children(value, vars(value), path)


def doks(source, target=None):
    lines = _doks(source)
    if target:
        with safer.printer(target) as _print:
            for line in lines:
                _print(line)
    else:
        for line in lines:
            print(line)


def main():
    doks(*sys.argv[1:])


if __name__ == '__main__':
    main()
